<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Upload de CSV</title>
    <style>
        table {
            width: 100%;
            border-collapse: collapse;
        }
        table, th, td {
            border: 1px solid black;
        }
        th, td {
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
        }
        #loadingIndicator {
            display: none;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <h1>Upload CSV</h1>
    <input type="file" id="csvFile" accept=".csv">
    <div id="loadingIndicator">Carregando...</div>
    <div id="output">
        <table id="csvTable"></table>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <script>
        document.getElementById("csvFile").addEventListener("change", handleFileSelect);

        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;

            const loadingIndicator = document.getElementById("loadingIndicator");
            const table = document.getElementById("csvTable");
            table.innerHTML = '';  // Limpa a tabela anterior

            loadingIndicator.style.display = 'block';

            const reader = new FileReader();
            reader.onload = function(e) {
                const text = e.target.result;

                Papa.parse(text, {
                    header: true,
                    encoding: "ISO-8859-1",
                    worker: true,
                    complete: function(results) {
                        loadingIndicator.style.display = 'none';
                        processCsvData(results.data);
                    },
                    error: function(err) {
                        console.error("Erro ao processar o arquivo", err);
                        loadingIndicator.style.display = 'none';
                    }
                });
            };

            reader.readAsText(file, "ISO-8859-1");
        }

        function processCsvData(data) {
            const table = document.getElementById("csvTable");
            const now = new Date(); // Data atual
            console.log("Data atual:", now);

            if (data.length > 0) {
                // Cria o cabeçalho da tabela
                const headers = ["Data do Primeiro Agendamento", "Tipo de Trabalho", "Número de compromisso", "Tempo até vencer"];
                const thead = document.createElement('thead');
                const headerRow = document.createElement('tr');
                headers.forEach(header => {
                    const th = document.createElement('th');
                    th.textContent = header;
                    headerRow.appendChild(th);
                });
                thead.appendChild(headerRow);
                table.appendChild(thead);

                // Cria o corpo da tabela
                const tbody = document.createElement('tbody');
                const processedData = [];

                data.forEach(row => {
                    const agendamento = row["Data do Primeiro Agendamento"];
                    const tipoTrabalho = row["Tipo de Trabalho"];
                    const numeroCompromisso = row["Número de compromisso"];

                    // Ignora linhas vazias
                    if (!agendamento || !tipoTrabalho || !numeroCompromisso) {
                        return; // Pula esta linha se qualquer um dos dados obrigatórios estiver ausente
                    }

                    // Ignora "Retirada de Equipamento"
                    if (tipoTrabalho === "Retirada de Equipamento") {
                        return; // Pula esta linha se o tipo de trabalho for "Retirada de Equipamento"
                    }

                    // Extraindo a data e hora do agendamento
                    const [dataAgendamento, horaAgendamento] = agendamento.split(" ");
                    const [dia, mes, ano] = dataAgendamento.split("/").map(Number);
                    const [hora, minuto] = horaAgendamento.split(":").map(Number);

                    // Verificação para garantir que a variável ano esteja correta
                    if (isNaN(ano) || isNaN(mes) || isNaN(dia) || isNaN(hora) || isNaN(minuto)) {
                        console.error("Data do Agendamento inválida:", agendamento);
                        return; // Pula esta linha se a data não estiver correta
                    }

                    // Determinando o prazo de vencimento com base no tipo de trabalho
                    let prazoVencimento = 0;
                    if (tipoTrabalho === "Manutenção") {
                        prazoVencimento = 24; // 24 horas
                    } else if (tipoTrabalho === "Mudança de endereço" || tipoTrabalho === "Ativação") {
                        prazoVencimento = 72; // 72 horas
                    } else {
                        return; // Se o tipo de trabalho não for relevante, ignora
                    }

                    // Calculando a data de vencimento
                    const dataVencimento = new Date(ano, mes - 1, dia, hora + prazoVencimento, minuto);
                    console.log("Data de Vencimento:", dataVencimento);

                    // Verificando se já venceu
                    let tempoRestante;
                    const diff = dataVencimento - now; // diferença em milissegundos

                    if (diff < 0) {
                        tempoRestante = "Já venceu";
                    } else {
                        const dias = Math.floor(diff / (1000 * 60 * 60 * 24));
                        const horas = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                        const minutos = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                        tempoRestante = `${dias} dias, ${horas} horas e ${minutos} minutos`;
                    }

                    processedData.push({
                        agendamento,
                        tipoTrabalho,
                        numeroCompromisso,
                        tempoRestante,
                        dataVencimento,
                        isVencido: diff < 0 // Adicionando um indicador para saber se já venceu
                    });
                });

                // Ordena os dados pelo tempo restante, colocando os não vencidos primeiro
                processedData.sort((a, b) => {
                    if (a.isVencido && !b.isVencido) return 1; // b primeiro
                    if (!a.isVencido && b.isVencido) return -1; // a primeiro
                    return a.dataVencimento - b.dataVencimento; // Ordena por data de vencimento se ambos forem iguais
                });

                // Exibe os dados na tabela
                processedData.forEach(item => {
                    const tr = document.createElement('tr');
                    const td1 = document.createElement('td');
                    td1.textContent = item.agendamento;
                    const td2 = document.createElement('td');
                    td2.textContent = item.tipoTrabalho;
                    const td3 = document.createElement('td');
                    td3.textContent = item.numeroCompromisso;
                    const td4 = document.createElement('td');
                    td4.textContent = item.tempoRestante;

                    tr.appendChild(td1);
                    tr.appendChild(td2);
                    tr.appendChild(td3);
                    tr.appendChild(td4);
                    tbody.appendChild(tr);
                });
                table.appendChild(tbody);
            }
        }
    </script>
</body>
</html>
